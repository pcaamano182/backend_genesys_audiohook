<!DOCTYPE html>
<html>

<head>
  <base href="/" />
  <title>Agent Assist UI Modules</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css?family=Roboto:medium" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css?family=Google+Sans:medium" rel="stylesheet" />
  <link rel="stylesheet" href="../public/css/styles.css" type="text/css">
  <!-- WebComponents polyfill. Needed for rendering web components in older browsers. -->
  <script src="https://www.gstatic.com/external_hosted/document_register_element/document-register-element.js"></script>
  <!-- Core UI module container. Loads all UI module-specific scripts. -->
  <script src="https://www.gstatic.com/agent-assist-ui-modules/v1.8/common.js"></script>
  <script src="https://www.gstatic.com/agent-assist-ui-modules/v1.3/transcript.js"></script>
  <script src="https://www.gstatic.com/agent-assist-ui-modules/v2.0/container.js"></script>
  <!-- Conversation Summarization UI Module -->
  <script src="https://www.gstatic.com/agent-assist-ui-modules/v1/summarization.js"></script>

</head>
<body>
  <div class="app-container">
    <div class="transcript-container"></div>
    <div class="summaries-panel" id="summaries-panel">
      <div class="summaries-header">üìä Conversation Summaries</div>
      <div class="summaries-content" id="summaries-content">
        <div class="no-summaries">No summaries generated yet...</div>
      </div>
    </div>
    <div class="ui-modules-wrapper">
      <div class="ui-modules-container"> </div>
    </div>
  </div>
  <script>

    // window._uiModuleFlags = { debug: true }
    window.addEventListener('load', function () {

      const UI_MODULES_EL_SELECTOR = 'agent-assist-ui-modules-v2';
      const TRANSCRIPT_SELECTOR = 'agent-assist-transcript';
      const proxyServer = '<%= proxyServer %>';
      const conversationProfile = '<%= conversationProfile %>';
      const features = '<%= features %>';
      const genesysCloudRegion = '<%= genesysCloudRegion %>';
      const clientId = '<%= clientID %>';
      const channel = '<%= channel %>';
      var applicationServer = '<%= applicationServer %>';
      var accessToken = '';
      const urlParams = new URLSearchParams(window.location.search);
      const currentConversationId = urlParams.get('conversationid');
      const gcHostOrigin = urlParams.get('gcHostOrigin');
      const gcTargetEnv = urlParams.get('gcTargetEnv') || genesysCloudRegion;
      applicationServer = applicationServer.replace(/\/$/, "");
      var firstTimeLoad = false;
      const redirectUri = `${applicationServer}?conversationProfile=${conversationProfile}&features=${features}&gcTargetEnv=${gcTargetEnv}`;
      var existingUiModulesEl = document.querySelector(UI_MODULES_EL_SELECTOR);
      const appContainer = document.querySelector('.app-container');
      const uiModulesContainer = document.querySelector('.ui-modules-container');
      const transcriptContainer = document.querySelector('.transcript-container');
      var connector;

      function createTranscriptUIElement() {
        const uiModulesTranscriptEl = document.createElement(TRANSCRIPT_SELECTOR);
        uiModulesTranscriptEl.style.maxHeight = '100%';
        transcriptContainer.appendChild(uiModulesTranscriptEl);
      }

      function createUIElement(accessToken) {
        if (existingUiModulesEl) {
          connector.setAuthToken(accessToken);
          connector.initGenesysCloudConnectorSubscription();
        } else {
          var uiModulesEl = document.createElement(UI_MODULES_EL_SELECTOR);
          uiModulesEl.setAttribute('features', features);
          uiModulesEl.config = getKnowledgeAssistConfig();
          uiModulesContainer.appendChild(uiModulesEl);

          initConnect();
        }
      }

      /* Make a V2 Connection */
      function initConnect() {
        connector = new UiModulesConnector();

        const config = {
          channel: channel,
          agentDesktop: 'GenesysCloud',
          conversationProfileName: conversationProfile,
          apiConfig: {
            authToken: accessToken,
            customApiEndpoint: proxyServer,
          },
          useCustomConversationId: true,
          oauthClientId: clientId,
          redirectUri: redirectUri,
          genesysCloudRegion: genesysCloudRegion,
          eventBasedConfig: {
            notifierServerEndpoint: proxyServer,
            library: 'SocketIo',
            auth: {
              token: accessToken
            }
          }
        }

        if (channel !== 'voice') {
          transcriptContainer.style.display = 'none';
        }

        connector.init(config);
      }

      function getKnowledgeAssistConfig() {
        return {
          knowledgeAssistConfig: {
            articleLinkConfig: {
              target: 'popup',
              popupWindowOptions: 'height=800,width=600,left=600,top=100',
            }
          }
        };
      }

      /** When the first time UI module load, parse an empty token */
      if (!existingUiModulesEl && !accessToken) {
        createUIElement(accessToken);
        if (channel === 'voice') {
          createTranscriptUIElement();
        }
      }

      /** After the genesys OAuth, get the access token */
      addAgentAssistEventListener(
        'genesys-cloud-connector-access-token-received', function (event) {
          const genesysCloudAccessToken = event.detail.accessToken;
          authenticateGenesysCloud(genesysCloudAccessToken).then(function (res) {
            if (res.status !== 200) {
              document.body.removeChild(existingUiModulesEl);
            }
            return res.json();
          }).then(function (body) {
            existingUiModulesEl = document.querySelector(UI_MODULES_EL_SELECTOR);
            // If there is unauthenticated existingUIModule,
            // the accessToken will be undefined
            // Set the accessToken to the existingUIModule
            firstTimeLoad = existingUiModulesEl && !accessToken;
            if (firstTimeLoad) {
              accessToken = body.token;
              createUIElement(accessToken);
            }
          });
        });

      addAgentAssistEventListener('smart-reply-selected', function (event) {
        navigator.clipboard.writeText(event.detail.answer.reply);
      });

      addAgentAssistEventListener('agent-coaching-response-selected', function (event) {
        navigator.clipboard.writeText(event.detail.selectedResponse);
      });

      /**
      * Authenticate the Genesys Cloud access token
      * @param {string} accessToken
      * @return {!Promise<number>}
      */
      function authenticateGenesysCloud(accessToken) {
        return fetch(proxyServer + '/register', {
                method: 'POST',
                headers: [['Authorization', accessToken]],
              });
        }

      /**
       * Initialize separate Socket.IO connection for summaries
       */
      function initSummaryListener() {
        console.log('üìä [SUMMARY] Initializing summary Socket.IO listener');

        // Import Socket.IO client library
        const script = document.createElement('script');
        script.src = 'https://cdn.socket.io/4.5.4/socket.io.min.js';
        script.onload = function() {
          console.log('üìä [SUMMARY] Socket.IO library loaded');

          // Connect to UI Connector with a separate socket for summaries
          const summarySocket = io(proxyServer, {
            auth: { token: accessToken }
          });

          let hasJoinedRoom = false;
          let currentConversationName = null;

          function joinConversationRoom(conversationName) {
            if (hasJoinedRoom) {
              console.log('‚ÑπÔ∏è [SUMMARY] Already joined room');
              return;
            }
            console.log('üîó [SUMMARY] Joining conversation room:', conversationName);
            summarySocket.emit('join-conversation', conversationName);
            hasJoinedRoom = true;
            currentConversationName = conversationName;
          }

          summarySocket.on('connect', function() {
            console.log('‚úÖ [SUMMARY] Connected - Socket ID:', summarySocket.id);

            // Rejoin room if reconnecting
            if (currentConversationName) {
              console.log('üîó [SUMMARY] Rejoining after reconnect:', currentConversationName);
              summarySocket.emit('join-conversation', currentConversationName);
            }
          });

          // Build conversation name from URL params
          function buildConversationNameAndJoin() {
            if (hasJoinedRoom) {
              return;
            }

            if (!currentConversationId) {
              console.log('‚ö†Ô∏è [SUMMARY] No conversationId in URL params yet, will retry...');
              setTimeout(buildConversationNameAndJoin, 1000);
              return;
            }

            console.log('üîç [SUMMARY] Building conversation name for conversationId:', currentConversationId);

            // Extract project from conversationProfile
            // Format: projects/{project}/locations/{location}/conversationProfiles/{id}
            const projectMatch = conversationProfile.match(/projects\/([^\/]+)/);
            if (!projectMatch) {
              console.error('‚ùå [SUMMARY] Could not extract project from conversationProfile');
              return;
            }
            const project = projectMatch[1];

            // Build conversation name (AudioHook adds 'a' prefix to Genesys conversation IDs)
            const normalizedConversationId = 'a' + currentConversationId;
            const conversationName = `projects/${project}/conversations/${normalizedConversationId}`;

            console.log('üéØ [SUMMARY] Built conversation name:', conversationName);
            joinConversationRoom(conversationName);
          }

          // Start trying to build conversation name
          buildConversationNameAndJoin();

          // Listen for summary events on the summary socket
          summarySocket.on('conversation-summarization-received', function(data) {
            console.log('üìù [SUMMARY] ===== Summary Received =====');
            console.log('üìù [SUMMARY] Data:', data);
            displaySummary(data);
          });

          // Log all events for debugging
          summarySocket.onAny(function(eventName, data) {
            console.log('üîä [SUMMARY] Socket event:', eventName);
          });

          summarySocket.on('disconnect', function() {
            console.log('‚ùå [SUMMARY] Disconnected');
            hasJoinedRoom = false;
          });
        };
        document.head.appendChild(script);
      }

      function displaySummary(data) {
        try {
          console.log('üìù [SUMMARY] Processing summary data:', data);

          const parsedData = JSON.parse(data.data);
          const summaryText = parsedData.payload.summary.text;

          console.log('üìù [SUMMARY] Summary text:', summaryText);

          const summariesContent = document.getElementById('summaries-content');
          const noSummaries = summariesContent.querySelector('.no-summaries');
          if (noSummaries) {
            noSummaries.remove();
          }

          const card = document.createElement('div');
          card.className = 'summary-card';

          const title = document.createElement('div');
          title.className = 'summary-title';
          title.textContent = 'üìä Periodic Summary';

          const content = document.createElement('div');
          content.className = 'summary-content';
          content.textContent = summaryText;

          const timestamp = document.createElement('div');
          timestamp.className = 'summary-timestamp';
          timestamp.textContent = `Generated at ${new Date().toLocaleTimeString()}`;

          card.appendChild(title);
          card.appendChild(content);
          card.appendChild(timestamp);
          summariesContent.insertBefore(card, summariesContent.firstChild);

          console.log('‚úÖ [SUMMARY] Summary displayed in panel');
        } catch (e) {
          console.error('‚ùå [SUMMARY] Error displaying summary:', e);
        }
      }

      // Initialize summary listener after authentication
      addAgentAssistEventListener('genesys-cloud-connector-access-token-received', function(event) {
        console.log('üìä [SUMMARY] Access token received, initializing summary socket');
        setTimeout(initSummaryListener, 2000);
      });

      });
  </script>
</body>

</html>